### Тестовое задание.

#### Техническое задание

[Исходная задача - ТЗ](./requirements.md)

#### База данных

В качестве базы данных используется MySQL. 

[Структура БД](./database.md)

#### Среда выполнения проекта

В качестве среды выполнения проекта используется Docker.
Для компоновки контейнеров используется Docker Compose.
Контейнеры расположены в папке **docker**

В составе проекта 3 контейнера:

* Контейнер database - сервер БД mysql:5.7.34
  Внутри папки контейнера находиться папка **data** в ней располагаются файлы с базами данных
* Контейнер app - сервер приложения php-fpm версия php 8.1
  Директория с исполняемыми PHP файлами зеркалирована в папку /src/public
* Контейнер nginx - веб сервер Nginx

#### Развертывание проекта

* [ ] Установить Docker
* [ ] Установить Docker-compose
* [ ] Перейти в папку /docker
* [ ] Выполнить команду ```docker-compose up -d```
* [ ] Перейти по адресу http://localhost:83
* [ ] Если загружается стартовая страница Symfony значит все работает
* [ ] Остановка контейнера docker-compose stop

#### Обновление курсов валют

Для обновления курсов валют используется сервис cbr.ru
Для обновления курсов:

* [ ] перейти в папку /docker
* [ ] выполнить команду 
  ```docker-compose exec app php /var/www/bin/console app:refresh-rates```

#### SQL запрос, который вернет сумму, полученную по причине refund за последние 7 дней.

Тут уже возникает вопрос, в какой валюте мы хотим получить результат. 

Поскольку у нас кошельки в разных валютах, и транзакции в разных валютах могут быть варианты.

Например, запрос ниже вернет суммы полученные по указанной причине за последние 7 суток от текущего момента, возвращены они будут в валютах кошельков, а не в валютах транзакций. Переводить все суммы к какой-то одной валюте мы не будем, поскольку итоговая сумма будет каждый день разная в зависимости от текущего курса. В результате получим несколько сумм сгруппированных по валютам кошельков.

```mysql
SELECT 
  w.currency_id,
  SUM(IF(wt.transaction_type = 'debit', wt.amount_wallet, -wt.amount_wallet)) AS total_amount
FROM wallet_transaction AS wt
INNER JOIN wallet AS w ON w.wallet_id = wt.wallet_id
WHERE wt.created > (UNIX_TIMESTAMP() - 86400 * 7)
AND wt.reason = 'refund'
GROUP BY w.currency_id
```

Можно написать запрос который вернет суммы в валютах транзакций, но это не совсем корректно, так как для нас ценность этих денег в разный день разная и мы не можем с ними что-то сделать.

Можно написать запрос который приведет все строки к одной в какой-то требуемой валюте по текущему курсу.